= PrÃ¡ce s 3D modely ve formÄ› meshÃ­
:imagesdir: ../images/mesh/
:toc:

== TriangulÃ¡rnÃ­ mesh

Existuje mnoho zpÅ¯sobÅ¯, jak reprezentovat 3D modely. NapÅ™Ã­klad
https://en.wikipedia.org/wiki/Constructive_solid_geometry[CSG strom],
jako v OpenSCADu, pÅ™Ã­padnÄ› rÅ¯znÃ© objemovÃ© oktalovÃ© reprezentace apod.

Pro 3D tisk se vÅ¡ak nejÄastÄ›ji pouÅ¾Ã­vÃ¡ *hraniÄnÃ­ reprezentace*,
konkrÃ©tnÄ› triangulÃ¡rnÃ­ mesh (nebo lÃ©pe Äesky trojÃºhelnÃ­kovÃ¡ sÃ­Å¥). Mesh
je kolekce bodÅ¯, hran a stÄ›n (polygonÅ¯ a facetÅ¯) ve trojrozmÄ›rnÃ©m
kartÃ©zskÃ©m souÅ™adnÃ©m systÃ©mu. Existuje nÄ›kolik rÅ¯znÃ½ch druhÅ¯ takovÃ©
meshe, my se budeme zabÃ½vat vÃ½hradnÄ› meshÃ­ triangulÃ¡rnÃ­, kde facetem
mÅ¯Å¾e bÃ½t pouze trojÃºhelnÃ­k. VÃ½hoda trojÃºhelnÃ­ku ve 3D prostoru je, Å¾e
tÅ™i body, neleÅ¾Ã­cÃ­ na jednÃ© pÅ™Ã­mce, vÅ¾dy tvoÅ™Ã­ trojÃºhelnÃ­k (4 body
nemusÃ­ v trojrozmÄ›rnÃ©m prostoru leÅ¾et v jednÃ© rovinÄ› a tvoÅ™it
ÄtyÅ™ÃºhelnÃ­k).

.Topologie meshe. ObrÃ¡zek upraven z https://commons.wikimedia.org/wiki/File:Mesh_overview.svg[Wikipedie].
image::mesh.svg[Mesh]


JednotlivÃ© facety tvoÅ™Ã­ â€vodotÄ›snouâ€œ hranici mezi vnitÅ™kem a vnÄ›jÅ¡kem 3D
modelu.

.Mesh reprezentujÃ­cÃ­ kouli
image::sphere.svg[Koule]

Na rozdÃ­l od CSG stromu se mesh vyznaÄuje tÃ­m, Å¾e nenese informace o
vÃ½znamu (nenÃ­ napÅ™Ã­klad parametrickÃ¡), na druhou stranu je velmi rychlÃ©
ji vykreslit, nebo dÃ¡le zpracovÃ¡vat. V kontextu OpenSCADu mÅ¯Å¾ete vnÃ­mat
mesh jako vÃ½sledek kompilace.

== FormÃ¡t STL

TriangulÃ¡rnÃ­ mesh lze uklÃ¡dat v rÅ¯znÃ½ch formÃ¡tech. NejpouÅ¾Ã­vanÄ›jÅ¡Ã­m
formÃ¡tem pro FDM 3D tisk je *formÃ¡t STL* (mezi dalÅ¡Ã­ patÅ™Ã­ OBJ, AMF, 3MF
a dalÅ¡Ã­). STL znamenÃ¡ _STereoLitography_ a je to formÃ¡t vyvinutÃ½
spoleÄnostÃ­ _3D Systems_ v roce 1987 jako univerzÃ¡lnÃ­ formÃ¡t pro rapid
prototyping.

PozdÄ›ji se objevily vÃ½znamy zkratky jako _Standard Triangle Language_
nebo _Standard Tessellation Language_.

Soubor ve formÃ¡tu STL obsahuje seznam trojÃºhelnÃ­kovÃ½ch facetÅ¯, jejich
vrcholÅ¯ a normÃ¡l. Existuje lidsky ÄitelnÃ¡
http://en.wikipedia.org/wiki/STL_(file_format)#ASCII_STL[ASCII] a
ÃºspornÄ›jÅ¡Ã­
http://en.wikipedia.org/wiki/STL_(file_format)#Binary_STL[binÃ¡rnÃ­]
varianta.

FormÃ¡t STL nenÃ­ otevÅ™enÃ½m formÃ¡tem, ale je velmi rozÅ¡Ã­Å™en, podporuje jej
mnoho programÅ¯ nejen ze svÄ›ta 3D tisku.

=== ASCII STL soubor

Syntaxe textovÃ©ho STL souboru je pomÄ›rnÄ› upovÃ­danÃ¡. ZaÄÃ­nÃ¡ klÃ­ÄovÃ½m
slovem `solid` a nÃ¡zvem meshe (kterÃ½ nenÃ­ Äasto vyuÅ¾Ã­vÃ¡m a bÃ½vÃ¡
nahrazovÃ¡n nÃ¡zvem programu, kterÃ½ byl pouÅ¾it k vygenerovÃ¡nÃ­ souboru).
PotÃ© nÃ¡sleduje definice vÅ¡ech facetÅ¯ a soubor konÄÃ­ direktivou
`endsolid` a opÄ›t nÃ¡zvem meshe.

(Soubor teoreticky mÅ¯Å¾e obsahovat vÃ­ce blokÅ¯ `solid`, ale v praxi se s
tÃ­m Äasto nesetkÃ¡te.)

Jeden facet obsahuje informaci o normÃ¡lovÃ©m vektoru a o tÅ™ech vrcholech.

[source,stl]
----
solid name

facet normal ni nj nk
    outer loop
        vertex v1x v1y v1z
        vertex v2x v2y v2z
        vertex v3x v3y v3z
    endloop
endfacet

...

endsolid name
----

PoÅ™adÃ­ vrcholÅ¯ facetu musÃ­ splÅˆovat pravidlo pravÃ© ruky: JestliÅ¾e palec
ukazuje ve smÄ›ru normÃ¡ly (tedy ven z objektu), stoÄenÃ© prsty udÃ¡vajÃ­
poÅ™adÃ­ vrcholÅ¯.

.NormÃ¡lovÃ½ vektor
image::normal_vector.svg[]

JednotlivÃ¡ ÄÃ­sla se dajÃ­ reprezentovat jak pomocÃ­ notace ÄÃ­sel s
plovoucÃ­ desetinou ÄÃ¡rkou, tak â€lidÅ¡tÄ›jÅ¡Ã­m zÃ¡pisemâ€œ, mÅ¯Å¾ete se tak
setkat napÅ™. s hodnotami `1`, `0.5` nebo `2.648000e-002`.

Zde je reÃ¡lnÃ½ pÅ™Ã­klad kostky z OpenSCADu:

[source,stl]
----
solid OpenSCAD_Model
  facet normal -1 0 0
    outer loop
      vertex 0 0 1
      vertex 0 1 1
      vertex 0 0 0
    endloop
  endfacet
...
  facet normal 1 0 0
    outer loop
      vertex 1 0 1
      vertex 1 0 0
      vertex 1 1 1
    endloop
  endfacet
endsolid OpenSCAD_Model
----

.Mesh reprezentujÃ­cÃ­ kostku
image::cube.svg[]

http://en.wikipedia.org/wiki/STL_(file_format)#Binary_STL[BinÃ¡rnÃ­ STL
soubor] obsahuje stejnÃ© informace, pouze v ÃºspornÄ›jÅ¡Ã­ podobÄ›. ÄŒÃ­sla jsou
reprezentovÃ¡na datovÃ½m typem `float32` v poÅ™adÃ­ little endian.

== ProhlÃ­Å¾enÃ­ STL souborÅ¯

STL soubory lze prohlÃ­Å¾et v mnoha programech:

* `cat` a `hexdump` pro ty s velkou pÅ™edstavivostÃ­ ğŸ˜
* https://github.com/admesh/ADMeshGUI/[ADMeshGUI] (Linux, macOS,
Windows)
* http://www.freestlview.com/[STLView] (Windows)
* http://www.pleasantsoftware.com/developer/pleasant3d/[Pleasant3D]
(macOS)
* nÃ¡stroje na Ãºpravu meshe jako http://www.meshlab.net/[MeshLab] nebo
https://github.com/3DprintFIT/netfabb-basic-download[Netfabb]
* modelovacÃ­ nÃ¡stroje jako https://www.blender.org/[Blender] apod.

.ADMeshGUI
image::admeshgui.png[]

== Chyby v triangulÃ¡rnÃ­ meshi

I syntakticky naprosto sprÃ¡vnÃ½ STL soubor nemusÃ­ sÃ©manticky dÃ¡vat vÅ¯bec
smysl. Mnoho STL souborÅ¯ mÅ¯Å¾e vlivem rÅ¯znÃ½ch faktorÅ¯ obsahovat Å™adu
chyb. O meshi, kterÃ¡ obsahuje chyby, se Å™Ã­kÃ¡, Å¾e je nevalidnÃ­.

.KaÅ¾dÃ¡ mesh musÃ­ jasnÄ› oddÄ›lovat vnitÅ™ek a vnÄ›jÅ¡ek objektu. ZodpovÄ›dnÃ½ 3D tiskaÅ™ Å™ekne ne https://cs.wikipedia.org/wiki/Kleinova_l%C3%A1hev[KleinovÄ› lÃ¡hvi]. ObrÃ¡zek z https://twitter.com/3DPrintedPanda/status/1066688569400586241[tohoto tweetu]
image::klein.jpg[Kleinova lahev]

Zde si pÅ™edstavÃ­me nÄ›kolik ÄastÃ½ch chyb v STL souborech:

=== NeuzavÅ™enÃ¡ mesh / dÃ­ra v meshi

Mesh nenÃ­ â€vodotÄ›snÃ¡â€œ a nÄ›kde obsahuje dÃ­ru.

.DÃ­ra v meshi
image::mesh_hole.svg[]

ÄŒasto dÃ­ra nenÃ­ zpÅ¯sobena chybÄ›jÃ­cÃ­m facetem, ale nepÅ™esnostÃ­ v ÄÃ­slech
s plovoucÃ­ desetinnou ÄÃ¡rkou s malou pÅ™esnostÃ­.

.DÃ­ra v meshi zpÅ¯sobenÃ¡ floatovou chybou
image::mesh_floaterror.svg[]

=== DuplicitnÃ­ facet

Na stejnÃ©m mÃ­stÄ› se nachÃ¡zÃ­ vÃ­ce facetÅ¯. NÄ›kdy jsou stejnÄ› orientovanÃ© a
plnÄ› se pÅ™ekrÃ½vajÃ­, jindy mÅ¯Å¾ou takovÃ© facety tvoÅ™it ÄÃ¡st modelu s
nulovÃ½m objemem.

.DuplicitnÃ­ facet
image::mesh_duplicate.svg[]

=== Å patnÄ› orientovanÃ½ facet


Orientace facetu je dÃ¡na poÅ™adÃ­m vrcholÅ¯ a normÃ¡lou. Tyto informace si
tedy mohou protiÅ™eÄit. NÄ›kdy je takÃ© ÄÃ¡st 3D modelu nebo celÃ½ model
otoÄen â€vnitÅ™kem venâ€œ.

.Å patnÄ› orientovanÃ© facety
image::mesh_flipped.svg[]

=== SdÃ­lenÃ¡ hrana Äi stÄ›na

Na prvnÃ­ pohled nevinnÃ¡ chyba, kterÃ¡ ale rozporuje fyzickÃ© reprezentaci
3D modelu. Je mezi tÄ›mito kostkami ÃºzkÃ¡ mezera, nebo jde Ãºzkou mezerou
projÃ­t z jednÃ© kostky do druhÃ©?

.SdÃ­lenÃ¡ hrana
image::mesh_commonedge.svg[]

=== ProtÃ­najÃ­cÃ­ se facety

PÅ™i spojovÃ¡nÃ­ vÃ­ce skoÅ™epin Äasto vnikÃ¡ chyba, kdy se facety navzÃ¡jem
protÃ­najÃ­.

Na obrÃ¡zku jsou nesprÃ¡vnÄ› (vlevo) a sprÃ¡vnÄ› (vpravo) spojenÃ© koule, dÃ­ra
v meshi je zde jen pro lepÅ¡Ã­ nÃ¡hled dovnitÅ™.

.ProtÃ­najÃ­cÃ­ se facet
image::mesh_intersect.png[]

== Oprava chyb v triangulÃ¡rnÃ­ meshi

Existuje mnoho programÅ¯, kterÃ© umoÅ¾ÅˆujÃ­ vÃ½Å¡e zmÃ­nÄ›nÃ© chyby opravovat.
NÄ›kdy jde o programy na modelovÃ¡nÃ­, kterÃ© â€navÃ­câ€œ umoÅ¾ÅˆujÃ­ takovÃ© chyby
detekovat a poloautomaticky opravovat, nÄ›kdy jde o specializovanÃ©
programy.

=== Blender

Z prvnÃ­ kategorie zmÃ­nÃ­me program Blender, kterÃ½ obsahuje nÃ¡stroje k
opravÄ› a anylÃ½ze meshÃ­. Existuje i
https://store.blender.org/product/blender-for-3d-printing/[vÃ½ukovÃ© DVD]
pro Blender zabÃ½vajÃ­cÃ­ se 3D tiskem. Pro studenty FIT ÄŒVUT jej mÃ¡me k
dispozici.

=== ADMesh

Mezi programy, kterÃ© se snaÅ¾Ã­ automaticky opravovat chyby v triangulÃ¡rnÃ­
meshi patÅ™Ã­ command line nÃ¡stroj http://github.com/admesh/admesh[ADMesh]
Äi vÃ½Å¡e zmÃ­nÄ›nÃ¡ grafickÃ¡ nadstavba
https://github.com/admesh/ADMeshGUI[ADMeshGUI]. VÃ½sledky ale nejsou
pÅ™Ã­liÅ¡ dobrÃ©.

=== Netfabb Basic

NejlepÅ¡Ã­ zkuÅ¡enost s opravou meshÃ­ mÃ¡me v programu *Netfabb Basic*.
BohuÅ¾el tento program nenÃ­ open source a jiÅ¾ nadÃ¡le neexistuje.

Pro Windows lze pouÅ¾Ã­t
https://www.autodesk.com/products/netfabb/free-trial[trail verzi
programu Netfabb], kterÃ¡ se po vyprÅ¡enÃ­ chovÃ¡ jako Netfabb Basic.

Pro ostatnÃ­ platformy lze vyuÅ¾Ã­t
https://github.com/3DprintFIT/netfabb-basic-download[naÅ¡e zÃ¡lohy
programu Netfabb Basic], kterÃ© jsou volnÄ› Å¡iÅ™itelnÃ©.

Na cviÄenÃ­ pouÅ¾Ã­vÃ¡me tento program.

.Pro program Netfabb Basic je k dispozici tento https://www.youtube.com/watch?v=bl1AIYqPvcE[videotutoriÃ¡l].
video::bl1AIYqPvcE[youtube]

== Soubory

* link:../stls/mesh/cube_bad.stl[cube_bad.stl] â€“ kostka z videa s
chybami
* link:../stls/mesh/cube_correct.stl[cube_correct.stl] â€“ kostka z videa
bez chyb
* link:../stls/mesh/aligator_mini_bad.stl[aligator_mini_bad.stl] â€“
aligÃ¡tor z videa (https://www.thingiverse.com/thing:21724[originÃ¡l CC
BY-SA Joseph Larson])
* link:../stls/mesh/bunny_trouble_piece.stl[bunny_trouble_piece.stl] â€“
krÃ¡lÃ­k z videa (https://www.thingiverse.com/thing:7578[CC BY-NC mrbug])
* link:../stls/mesh/tajmahal.stl[tajmahal.stl] â€“ nebodovanÃ¡ Ãºloha na
procviÄenÃ­ (https://www.thingiverse.com/thing:11183[CC BY-SA Nicholas
Wilson])
